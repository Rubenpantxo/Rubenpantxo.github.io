<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Tejado Solar (Diseño Visual)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; cursor: default; }
        .result-card { background: linear-gradient(145deg, #1e3a8a, #3b82f6); }
        .card { background-color: rgba(55, 65, 81, 0.5); border: 1px solid #4b5567; }
        .tool-btn.active { background-color: #3b82f6; color: white; transform: scale(1.05); box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .asset { cursor: grab; transition: transform 0.2s ease; }
        .asset:hover { transform: scale(1.05); }
        .asset:active { cursor: grabbing; }
        .texture-thumb { cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; background-size: cover; background-position: center;}
        .texture-thumb:hover, .texture-thumb.active { border-color: #3b82f6; }
        #canvas-container { position: relative; }
        #roofCanvas { background-size: 250px; background-repeat: repeat; image-rendering: auto; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center min-h-screen p-4 overflow-hidden">

    <div class="w-full max-w-full mx-auto flex flex-col lg:flex-row gap-4 h-[95vh]">

        <!-- Panel de Controles Izquierdo -->
        <div class="w-full lg:w-1/4 xl:w-1/5 flex flex-col gap-4">
            <header class="text-center">
                <h1 class="text-2xl font-bold text-blue-400">Diseño Solar Visual</h1>
            </header>
            
            <div class="card p-4 rounded-xl">
                <h2 class="text-xl font-bold mb-3">Componentes</h2>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Panel Solar -->
                    <div id="asset-panel" draggable="true" class="asset bg-gray-800 p-2 rounded-lg flex flex-col items-center justify-center text-center aspect-w-3 aspect-h-4">
                        <img src="https://Rubenpantxo.github.io/img/Panel1800x1134.png" alt="Panel Solar" class="max-h-24 object-contain pointer-events-none">
                        <span class="text-xs mt-1">Panel</span>
                    </div>
                    <!-- Perfil de Montaje -->
                    <div id="asset-profile" draggable="true" class="asset bg-gray-800 p-2 rounded-lg flex flex-col items-center justify-center text-center">
                        <img src="https://Rubenpantxo.github.io/img/Perfil3500x60.png" alt="Perfil de Montaje" class="h-24 object-contain pointer-events-none transform -rotate-45">
                        <span class="text-xs mt-1">Perfil</span>
                    </div>
                </div>
            </div>

            <!-- Configuración de Componentes -->
            <div class="card p-4 rounded-xl">
                <h2 class="text-xl font-bold mb-3">Configuración</h2>
                <div class="space-y-3">
                    <div>
                        <h4 class="font-semibold text-sm mb-1 text-gray-300">Panel Solar</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="text-xs">Ancho (mm)
                                <input id="panel-width" type="number" value="1134" class="config-input mt-1 w-full bg-gray-800 rounded p-1 text-sm">
                            </label>
                            <label class="text-xs">Alto (mm)
                                <input id="panel-height" type="number" value="1800" class="config-input mt-1 w-full bg-gray-800 rounded p-1 text-sm">
                            </label>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-sm mb-1 text-gray-300">Perfil</h4>
                        <div class="grid grid-cols-1 gap-2">
                            <label class="text-xs">Longitud (mm)
                                <input id="profile-length" type="number" value="3500" class="config-input mt-1 w-full bg-gray-800 rounded p-1 text-sm">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="result-card text-white p-4 rounded-xl shadow-lg text-center flex-grow flex flex-col justify-center">
                <h3 class="text-md font-medium opacity-80">Paneles / Piezas</h3>
                <div class="flex justify-around items-center mt-2">
                    <div class="text-center">
                        <p id="totalPanels" class="text-4xl font-bold">0</p>
                        <span class="text-xs opacity-80">Paneles</span>
                    </div>
                    <div class="text-center">
                        <p id="totalClamps" class="text-4xl font-bold">0</p>
                        <span class="text-xs opacity-80">Piezas</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Central (Canvas) -->
        <div class="w-full lg:w-1/2 xl:w-3/5 h-full rounded-lg shadow-2xl border border-blue-500/30 p-2 flex flex-col gap-2">
            <div id="canvas-toolbar" class="flex items-center justify-between p-2 bg-gray-800/50 rounded-lg">
                <div class="flex gap-2">
                    <!-- Herramientas -->
                    <button data-mode="move" class="tool-btn active bg-gray-700 p-2 rounded-lg" title="Mover y Seleccionar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 9l-3 3 3 3"/>
                            <path d="M9 5l3-3 3 3"/>
                            <path d="M15 19l-3 3-3-3"/>
                            <path d="M19 9l3 3-3 3"/>
                            <path d="M2 12h20"/>
                            <path d="M12 2v20"/>
                        </svg>
                    </button>
                    <button data-mode="delete" class="tool-btn bg-gray-700 p-2 rounded-lg" title="Borrar Elemento">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </div>
                <div class="text-sm text-gray-400">Rueda del ratón: Zoom. Clic derecho: Mover vista.</div>
            </div>
            <div id="canvas-container" class="w-full h-full bg-gray-800 rounded-lg">
                <canvas id="roofCanvas" class="w-full h-full"></canvas>
            </div>
        </div>
        
        <!-- Panel Derecho -->
        <div class="w-full lg:w-1/4 xl:w-1/5 flex flex-col gap-4">
            <div class="card p-4 rounded-xl">
                <h2 class="text-xl font-bold mb-3">Textura del Tejado</h2>
                <div id="texture-selector" class="grid grid-cols-2 gap-2">
                    <!-- Teja Tradicional -->
                    <div data-texture="https://Rubenpantxo.github.io/img/tejas.jpg" class="texture-thumb active aspect-square rounded"
                         style="background-image: url('https://Rubenpantxo.github.io/img/tejas.jpg')" alt="Teja Tradicional"></div>
                    <!-- Teja Plana -->
                    <div data-texture="https://Rubenpantxo.github.io/img/tejas_2.jpg" class="texture-thumb aspect-square rounded"
                         style="background-image: url('https://Rubenpantxo.github.io/img/tejas_2.jpg')" alt="Teja Plana"></div>
                    <!-- Pizarra Oscura -->
                    <div data-texture="https://Rubenpantxo.github.io/img/tejas_3.jpg" class="texture-thumb aspect-square rounded"
                         style="background-image: url('https://Rubenpantxo.github.io/img/tejas_3.jpg')" alt="Pizarra Oscura"></div>
                    <!-- Teja Mixta (reutilizada) -->
                    <div data-texture="https://Rubenpantxo.github.io/img/tejas_3.jpg" class="texture-thumb aspect-square rounded"
                         style="background-image: url('https://Rubenpantxo.github.io/img/tejas_3.jpg')" alt="Teja Mixta"></div>
                </div>
            </div>
            <div id="controls-container" class="card p-4 rounded-xl flex-grow overflow-y-auto">
                <h2 class="text-xl font-bold mb-3">Zonas del Tejado</h2>
                <div id="zonesContainer" class="space-y-4"></div>
                <button id="addZoneBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">+ Añadir Zona</button>
            </div>
        </div>
    </div>

<script>
(() => {
  const app = document.getElementById('apps-content');
  if (!app) return; // no afecta a otras secciones

  // Helpers
  const qs  = (sel) => app.querySelector(sel);

  // DOM dentro de #apps-content
  const canvas            = qs('#roofCanvas');
  const ctx               = canvas?.getContext('2d');
  const zonesContainer    = qs('#zonesContainer');
  const addZoneBtn        = qs('#addZoneBtn');
  const totalPanelsEl     = qs('#totalPanels');
  const totalClampsEl     = qs('#totalClamps');
  const toolbar           = qs('#canvas-toolbar');
  const assetPanel        = qs('#asset-panel');
  const assetProfile      = qs('#asset-profile');
  const textureSelector   = qs('#texture-selector');
  const panelWidthInput   = qs('#panel-width');
  const panelHeightInput  = qs('#panel-height');
  const profileLengthInput= qs('#profile-length');

  if (!canvas || !ctx || !zonesContainer || !addZoneBtn || !toolbar ||
      !assetPanel || !assetProfile || !textureSelector ||
      !panelWidthInput || !panelHeightInput || !profileLengthInput) return;

  // Constantes visuales
  const PROFILE_VISUAL_WIDTH = 40;
  const CLAMP_MID_WIDTH = 40;
  const CLAMP_END_WIDTH = 25;
  const CLAMP_HEIGHT = 50;

  // Estado
  let state = {
    zones: [], profiles: [], panels: [], clamps: [],
    mode: 'move', selectedObject: null, isDragging: false, isPanning: false,
    dragOffset: { x: 0, y: 0 }, panStart: { x: 0, y: 0 },
    scale: 0.05, panOffset: { x: 50, y: 50 }
  };
  let zoneCounter = 0; let elementCounter = 0;

  // Zonas
  function addZone(width = 5970, height = 3420) {
    zoneCounter++;
    const zone = { id: `zone-${zoneCounter}`, width, height };
    state.zones.push(zone); renderZoneControls(); draw();
  }
  function removeZone(id) {
    state.zones = state.zones.filter(z => z.id !== id); renderZoneControls(); draw();
  }
  function updateZone(id, field, value) {
    const zone = state.zones.find(z => z.id === id);
    if (zone) { zone[field] = parseInt(value) || 0; draw(); }
  }
  function renderZoneControls() {
    zonesContainer.innerHTML = state.zones.map(zone => `
      <div class="bg-gray-700/50 p-3 rounded-lg">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-bold text-md text-blue-300">Zona ${zone.id.split('-')[1]}</h3>
          <button class="remove-zone-btn text-red-400 hover:text-red-300" data-id="${zone.id}">✕</button>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">Ancho<input type="number" value="${zone.width}" data-field="width" data-id="${zone.id}" class="zone-input mt-1 w-full bg-gray-800 rounded p-1 text-sm"></label>
          <label class="text-xs">Alto<input type="number" value="${zone.height}" data-field="height" data-id="${zone.id}" class="zone-input mt-1 w-full bg-gray-800 rounded p-1 text-sm"></label>
        </div>
      </div>`).join('');
  }

  // Dibujo
  function draw() {
    const parent = canvas.parentElement;
    canvas.width = parent.clientWidth; canvas.height = parent.clientHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(state.panOffset.x, state.panOffset.y); ctx.scale(state.scale, state.scale);

    ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)'; ctx.lineWidth = 5 / state.scale; ctx.setLineDash([15 / state.scale, 15 / state.scale]);
    state.zones.forEach(z => ctx.strokeRect(0, 0, z.width, z.height));
    ctx.setLineDash([]);

    ctx.fillStyle = '#9ca3af';
    state.profiles.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));

    state.panels.forEach(p => {
      ctx.fillStyle = 'rgba(30, 58, 138, 0.85)';
      ctx.fillRect(p.x, p.y, p.width, p.height);
      ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 15 / state.scale;
      ctx.strokeRect(p.x, p.y, p.width, p.height);
    });

    state.clamps.forEach(c => {
      ctx.fillStyle = c.clampType === 'mid' ? 'rgba(234, 179, 8, 0.9)' : 'rgba(168, 85, 247, 0.9)';
      ctx.fillRect(c.x, c.y, c.width, c.height);
    });

    if (state.selectedObject) {
      ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 20 / state.scale;
      const s = state.selectedObject; ctx.strokeRect(s.x, s.y, s.width, s.height);
    }
    ctx.restore();
    updateTotals();
  }

  // Cálculo de clamps
  function updateClamps() {
    state.clamps = [];
    state.profiles.forEach(p => {
      const panelsOnProfile = [];
      const isHorizProfile = p.width > p.height;
      state.panels.forEach(panel => {
        const isVertPanel = panel.height > panel.width;
        if (isHorizProfile && isVertPanel) {
          const y_overlap = panel.y < p.y + p.height && panel.y + panel.height > p.y;
          const x_midpoint_inside = (panel.x + panel.width/2) > p.x && (panel.x + panel.width/2) < p.x + p.width;
          if (y_overlap && x_midpoint_inside) panelsOnProfile.push(panel);
        } else if (!isHorizProfile && !isVertPanel) {
          const x_overlap = panel.x < p.x + p.width && panel.x + panel.width > p.x;
          const y_midpoint_inside = (panel.y + panel.height/2) > p.y && (panel.y + panel.height/2) < p.y + p.height;
          if (x_overlap && y_midpoint_inside) panelsOnProfile.push(panel);
        }
      });
      if (isHorizProfile) panelsOnProfile.sort((a,b)=>a.x-b.x); else panelsOnProfile.sort((a,b)=>a.y-b.y);
      if (panelsOnProfile.length > 0) {
        const first = panelsOnProfile[0], last = panelsOnProfile[panelsOnProfile.length-1];
        if (isHorizProfile) {
          state.clamps.push({x:first.x-CLAMP_END_WIDTH,y:p.y,width:CLAMP_END_WIDTH,height:CLAMP_HEIGHT,clampType:'end'});
          state.clamps.push({x:last.x+last.width,y:p.y,width:CLAMP_END_WIDTH,height:CLAMP_HEIGHT,clampType:'end'});
        } else {
          state.clamps.push({y:first.y-CLAMP_END_WIDTH,x:p.x,height:CLAMP_END_WIDTH,width:CLAMP_HEIGHT,clampType:'end'});
          state.clamps.push({y:last.y+last.height,x:p.x,height:CLAMP_END_WIDTH,width:CLAMP_HEIGHT,clampType:'end'});
        }
      }
      for (let i=0;i<panelsOnProfile.length-1;i++){
        const p1=panelsOnProfile[i], p2=panelsOnProfile[i+1];
        if (isHorizProfile){
          const gap=p2.x-(p1.x+p1.width);
          if (gap>0 && gap<100) state.clamps.push({x:p1.x+p1.width+gap/2-CLAMP_MID_WIDTH/2,y:p.y,width:CLAMP_MID_WIDTH,height:CLAMP_HEIGHT,clampType:'mid'});
        } else {
          const gap=p2.y-(p1.y+p1.height);
          if (gap>0 && gap<100) state.clamps.push({y:p1.y+p1.height+gap/2-CLAMP_MID_WIDTH/2,x:p.x,height:CLAMP_MID_WIDTH,width:CLAMP_HEIGHT,clampType:'mid'});
        }
      }
    });
    draw();
  }

  // Picking
  function getObjectAt(worldX, worldY) {
    for (const p of [...state.panels].reverse()) if (worldX>p.x && worldX<p.x+p.width && worldY>p.y && worldY<p.y+p.height) return p;
    for (const p of [...state.profiles].reverse()) if (worldX>p.x && worldX<p.x+p.width && worldY>p.y && worldY<p.y+p.height) return p;
    return null;
  }

  // Interacción canvas
  function worldMousePos(screenX, screenY) {
    const rect = canvas.getBoundingClientRect();
    const x = (screenX - rect.left - state.panOffset.x) / state.scale;
    const y = (screenY - rect.top  - state.panOffset.y) / state.scale;
    return { x, y };
  }
  function handleMouseDown(e){
    if (e.button===2){ state.isPanning=true; state.panStart={x:e.clientX,y:e.clientY}; return;}
    const worldPos=worldMousePos(e.clientX,e.clientY);
    const object=getObjectAt(worldPos.x,worldPos.y);
    state.selectedObject=object;
    if (state.mode==='move' && object){
      state.isDragging=true;
      state.dragOffset.x=worldPos.x-object.x;
      state.dragOffset.y=worldPos.y-object.y;
    } else if (state.mode==='delete' && object){
      if (object.type==='panel') state.panels=state.panels.filter(p=>p.id!==object.id);
      if (object.type==='profile') state.profiles=state.profiles.filter(p=>p.id!==object.id);
      state.selectedObject=null; updateClamps();
    }
    draw();
  }
  function handleMouseMove(e){
    if (state.isPanning){
      const dx=e.clientX-state.panStart.x, dy=e.clientY-state.panStart.y;
      state.panOffset.x+=dx; state.panOffset.y+=dy;
      state.panStart={x:e.clientX,y:e.clientY}; draw(); return;
    }
    if (state.isDragging && state.selectedObject){
      const worldPos=worldMousePos(e.clientX,e.clientY);
      state.selectedObject.x=worldPos.x-state.dragOffset.x;
      state.selectedObject.y=worldPos.y-state.dragOffset.y; draw();
    }
  }
  function handleMouseUp(){ if (state.isDragging) updateClamps(); state.isDragging=false; state.isPanning=false; }
  function handleWheel(e){
    e.preventDefault();
    const zoomIntensity=0.1, wheel=e.deltaY<0?1:-1, zoom=Math.exp(wheel*zoomIntensity);
    const mousePos=worldMousePos(e.clientX,e.clientY);
    state.panOffset.x -= mousePos.x * (zoom - 1);
    state.panOffset.y -= mousePos.y * (zoom - 1);
    state.scale *= zoom; draw();
  }

  // DnD
  function setupDragAndDrop(){
    assetPanel.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', 'panel'));
    assetProfile.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', 'profileH'));
    canvas.addEventListener('dragover', e => e.preventDefault());
    canvas.addEventListener('drop', e => {
      e.preventDefault();
      const type = e.dataTransfer.getData('text/plain');
      const worldPos = worldMousePos(e.clientX, e.clientY);
      elementCounter++; const id = `el-${elementCounter}`;
      const panelW = parseInt(panelWidthInput.value);
      const panelH = parseInt(panelHeightInput.value);
      const profileL = parseInt(profileLengthInput.value);
      if (type==='panel'){
        state.panels.push({ id, type:'panel', x:worldPos.x-panelW/2, y:worldPos.y-panelH/2, width:panelW, height:panelH });
      } else if (type==='profileH'){
        state.profiles.push({ id, type:'profile', x:worldPos.x-profileL/2, y:worldPos.y-PROFILE_VISUAL_WIDTH/2, width:profileL, height:PROFILE_VISUAL_WIDTH });
      }
      updateClamps();
    });
  }

  function updateTotals(){ totalPanelsEl.textContent = state.panels.length; totalClampsEl.textContent = state.clamps.length; }

  // Eventos UI
  function setupEventListeners(){
    addZoneBtn.addEventListener('click', () => addZone());
    zonesContainer.addEventListener('input', e => { if (e.target.classList.contains('zone-input')) updateZone(e.target.dataset.id, e.target.dataset.field, e.target.value); });
    zonesContainer.addEventListener('click', e => { if (e.target.classList.contains('remove-zone-btn')) removeZone(e.target.dataset.id); });
    toolbar.addEventListener('click', e => {
      const button = e.target.closest('.tool-btn');
      if (button){ state.mode = button.dataset.mode; app.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); }
    });
    textureSelector.addEventListener('click', e => {
      const thumb = e.target.closest('.texture-thumb'); if (!thumb) return;
      const textureUrl = thumb.dataset.texture;
      canvas.style.backgroundImage = `url(${textureUrl})`;
      app.querySelectorAll('.texture-thumb').forEach(t => t.classList.remove('active'));
      thumb.classList.add('active');
    });
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);
    canvas.addEventListener('mouseleave', () => { state.isDragging=false; state.isPanning=false; });
    canvas.addEventListener('wheel', handleWheel, { passive:false });
    canvas.addEventListener('contextmenu', e => e.preventDefault());
    new ResizeObserver(draw).observe(canvas.parentElement);
  }

  // Init seguro
  addZone();
  setupEventListeners();
  setupDragAndDrop();
  const firstTex = app.querySelector('.texture-thumb'); if (firstTex) firstTex.click();
})();
</script>
</body>
</html>
