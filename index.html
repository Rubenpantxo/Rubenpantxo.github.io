<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Â¡Coge Alcachofas!</title>
  <style>
    /* Estilos generales */
    body {
      margin: 0;
      padding: 0;
      background: #fff;
      font-family: Arial, sans-serif;
    }
    /* MenÃº principal */
    #mainMenu {
      text-align: center;
      padding: 20px;
    }
    .level-select {
      margin-bottom: 20px;
      font-size: 1.1em;
    }
    .level-select span {
      margin-right: 10px;
    }
    .level-select label {
      margin: 0 10px;
      cursor: pointer;
    }
    .menu-bg {
      position: relative;
      display: inline-block;
      max-width: 90%;
      width: 600px;
    }
    .menu-bg img {
      width: 100%;
      height: auto;
      display: block;
    }
    .menu-button, .menu-text {
      position: absolute;
      width: 100%;
      left: 0;
      text-align: center;
      font-weight: bold;
      font-size: 2.5em;
      color: #fff;
      text-shadow: 2px 2px 4px #000;
      text-decoration: none;
    }
    /* Posiciones de texto en el palet (3 tablas) */
    #playBtn { top: 50%; transform: translateY(-50%); }
    #pauseLabel { top: 15%; }
    #continueBtn { top: 50%; transform: translateY(-50%); }
    #menuBtn { top: 85%; transform: translateY(-50%); }
    /* Botones de Volver y Pausa en el juego */
    #backButton, #pauseButton {
      position: absolute;
      top: 10px;
      padding: 5px 10px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      text-decoration: none;
      font-weight: bold;
      border-radius: 5px;
      z-index: 1000;
    }
    #backButton { right: 10px; }
    #pauseButton { left: 50%; transform: translateX(-50%); }
    /* HUD del juego (tiempo y contadores) */
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    /* Mensajes de juego */
    #llenoMsg {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      color: yellow;
      font-weight: bold;
      text-shadow: 1px 1px 2px #000;
      display: none;
    }
    #gameOver {
      position: absolute;
      top: 40%;
      width: 100%;
      text-align: center;
      color: #fff;
      text-shadow: 2px 2px 4px #000;
      display: none;
    }
    #gameOver h2 {
      font-size: 2em;
      margin-bottom: 0.2em;
    }
    #gameOver p {
      font-size: 1.2em;
      margin: 0.2em;
    }
    /* Overlay de pausa */
    #pauseOverlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex-direction: column;
    }
    #pauseOverlay .menu-bg {
      position: relative;
      max-width: 80%;
      width: 500px;
    }
    #pauseOverlay .menu-bg img {
      width: 100%;
      height: auto;
    }
    #pauseOverlay .menu-button, #pauseOverlay .menu-text {
      position: absolute;
      width: 100%;
      left: 0;
      text-align: center;
      font-weight: bold;
      font-size: 2em;
      color: #fff;
      text-shadow: 2px 2px 4px #000;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <!-- MenÃº principal -->
  <div id="mainMenu">
    <div class="level-select">
      <span>Selecciona nivel:</span>
      <label><input type="radio" name="level" value="1" checked /> 1</label>
      <label><input type="radio" name="level" value="2" /> 2</label>
      <label><input type="radio" name="level" value="3" /> 3</label>
    </div>
    <div class="menu-bg">
      <img src="img/1_Palet.png" alt="MenÃº Principal" />
      <a href="#" id="playBtn" class="menu-button" onclick="game.level=parseInt(document.querySelector('input[name=level]:checked').value); startGame(); return false;">JUGAR</a>
    </div>
  </div>

  <!-- Contenedor del juego -->
  <div id="gameContainer" style="display:none; position: relative;">
    <canvas id="gameCanvas"></canvas>
    <div id="hud">
      <div id="timer">Tiempo: 00:00</div>
      <div id="artichokes">Alcachofas: 0/5</div>
      <div id="total">Total recogidas: 0</div>
    </div>
    <div id="llenoMsg">Â¡Cesto lleno! Ve al tractor para vaciarlo.</div>
    <div id="gameOver">
      <h2>Â¡Juego terminado!</h2>
      <p id="finalTime"></p>
    </div>
    <!-- MenÃº de Pausa -->
    <div id="pauseOverlay">
      <div class="menu-bg">
        <img src="img/1_Palet.png" alt="Pausa" />
        <div id="pauseLabel" class="menu-text">PAUSA</div>
        <a href="#" id="continueBtn" class="menu-button" onclick="resumeGame(); return false;">CONTINUAR</a>
        <a href="#" id="menuBtn" class="menu-button" onclick="exitGame(); return false;">MENÃš PRINCIPAL</a>
        <img src="img/1_descanso.png" alt="Personaje descansando" style="position:absolute; bottom: 0; right: 20px; width: 100px; height: auto;" />
      </div>
    </div>
    <a href="#" id="backButton" onclick="exitGame(); return false;">&larr; Volver</a>
    <a href="#" id="pauseButton" onclick="pauseGame(); return false;">PAUSA</a>
  </div>

  <script>
    // =================================================================
    // === LÃ“GICA DEL JUEGO (JavaScript Nativo) =========================
    // =================================================================
    const game = {
      // Elementos del DOM
      container: document.getElementById('gameContainer'),
      canvas: document.getElementById('gameCanvas'),
      ctx: null,
      ui: {
        timer: document.getElementById('timer'),
        artichokes: document.getElementById('artichokes'),
        total: document.getElementById('total'),
        llenoMsg: document.getElementById('llenoMsg'),
        gameOver: document.getElementById('gameOver'),
        finalTime: document.getElementById('finalTime')
      },
      // Estado del juego
      running: false,
      paused: false,
      keys: {},
      startTime: 0,
      // ConfiguraciÃ³n del juego
      config: {
        MAX_CARRIED: 5,
        FIELD_COLOR: '#8B4513',
        TOTAL_ARTICHOKES: 50
      },
      // Recursos (imÃ¡genes)
      assets: {
        playerNormal: { img: new Image(), src: 'img/2_Agricul.png' },
        playerTired:  { img: new Image(), src: 'img/1_cansado.png' },
        playerFallen: { img: new Image(), src: 'img/1_caida.png' },
        tractor:      { img: new Image(), src: 'img/TratorðŸšœ.png' },
        artichoke:    { img: new Image(), src: 'img/Alcachofa.png' },
        obstacle1:    { img: new Image(), src: 'img/Piedra_1_obs.png' },
        obstacle2:    { img: new Image(), src: 'img/Piedra_2_obs.png' },
        background1:  { img: new Image(), src: 'img/Textura_tierra_1.png' },
        background2:  { img: new Image(), src: 'img/Textura_tierra_2.png' },
        background3:  { img: new Image(), src: 'img/Textura_tierra_3.png' }
      },
      // Entidades del juego
      player: {},
      tractor: {},
      artichokes: [],
      obstacles: [],
      // Contadores
      carried: 0,
      collected: 0,
      level: 1
    };

    function initGameAssets() {
      // Cargar todas las imÃ¡genes
      for (const key in game.assets) {
        if (game.assets.hasOwnProperty(key)) {
          game.assets[key].img.src = game.assets[key].src;
        }
      }
    }

    function startGame() {
      // Mostrar la secciÃ³n de juego y ocultar el menÃº principal
      game.container.style.display = 'block';
      document.getElementById('mainMenu').style.display = 'none';
      // Ocultar mensajes de fin de juego/pausa
      game.ui.gameOver.style.display = 'none';
      document.getElementById('pauseOverlay').style.display = 'none';
      document.getElementById('backButton').style.display = 'block';
      // Inicializar contexto de dibujo
      if (!game.ctx) {
        game.ctx = game.canvas.getContext('2d');
      }
      // Resetear estado del juego
      game.running = true;
      game.paused = false;
      game.keys = {};
      game.carried = 0;
      game.collected = 0;
      game.player.isTired = false;
      game.player.isFrozen = false;
      game.startTime = performance.now();
      // Posicionar jugador y tractor
      game.player = { x: game.canvas.width / 2, y: game.canvas.height - 120, w: 48, h: 48, speed: 2, isTired: false, isFrozen: false };
      game.tractor = { x: game.canvas.width / 2 - 64, y: 40, w: 128, h: 96 };
      // Generar alcachofas aleatorias en el campo
      game.artichokes = [];
      for (let i = 0; i < game.config.TOTAL_ARTICHOKES; i++) {
        game.artichokes.push({
          x: Math.random() * (game.canvas.width - 40) + 20,
          y: Math.random() * (game.canvas.height - 240) + 140,
          w: 32, h: 32, taken: false
        });
      }
      // Generar obstÃ¡culos aleatorios en el campo
      game.obstacles = [];
      for (let j = 0; j < 5; j++) {
        const obsX = Math.random() * (game.canvas.width - 80) + 40;
        const obsY = Math.random() * (game.canvas.height - 240) + 140;
        game.obstacles.push({
          x: obsX,
          y: obsY,
          w: 48, h: 48,
          taken: false,
          type: (Math.random() < 0.5 ? 'obstacle1' : 'obstacle2')
        });
      }
      // Ajustar el canvas al tamaÃ±o de la ventana
      resizeCanvas();
      // Comenzar el bucle del juego
      requestAnimationFrame(gameLoop);
    }

    function exitGame() {
      // Volver al menÃº principal
      game.running = false;
      game.paused = false;
      game.container.style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
    }

    function pauseGame() {
      if (game.running && !game.paused) {
        game.paused = true;
        game.running = false;
        document.getElementById('pauseOverlay').style.display = 'flex';
        document.getElementById('backButton').style.display = 'none';
      }
    }

    function resumeGame() {
      if (game.paused) {
        document.getElementById('pauseOverlay').style.display = 'none';
        game.paused = false;
        game.running = true;
        document.getElementById('backButton').style.display = 'block';
        // Nota: No ajustamos el temporizador para simplicidad
        requestAnimationFrame(gameLoop);
      }
    }

    function gameLoop() {
      if (!game.running) return;
      update();
      render();
      requestAnimationFrame(gameLoop);
    }

    function update() {
      // Movimiento del jugador por teclas (si no estÃ¡ congelado)
      if (!game.player.isFrozen) {
        if (game.keys['ArrowLeft'] || game.keys['a']) game.player.x -= game.player.speed;
        if (game.keys['ArrowRight'] || game.keys['d']) game.player.x += game.player.speed;
        if (game.keys['ArrowUp'] || game.keys['w']) game.player.y -= game.player.speed;
        if (game.keys['ArrowDown'] || game.keys['s']) game.player.y += game.player.speed;
      }
      // Limitar el movimiento a los bordes del canvas
      game.player.x = clamp(game.player.x, 0, game.canvas.width - game.player.w);
      game.player.y = clamp(game.player.y, 0, game.canvas.height - game.player.h);
      // RecolecciÃ³n de alcachofas (solo si no lleva el mÃ¡ximo)
      if (game.carried < game.config.MAX_CARRIED) {
        game.artichokes.forEach(a => {
          if (!a.taken && checkCollision(game.player, a)) {
            a.taken = true;
            game.carried++;
            game.collected++;
            // Al recolectar 5 alcachofas en total, personaje se cansa
            if (!game.player.isTired && game.collected >= 5) {
              game.player.isTired = true;
              game.player.speed = 1;  // reducir velocidad (mÃ¡s lento)
            }
          }
        });
      }
      // Mostrar mensaje de inventario lleno
      game.ui.llenoMsg.style.display = (game.carried >= game.config.MAX_CARRIED) ? 'block' : 'none';
      // ColisiÃ³n con el tractor para descargar alcachofas
      if (game.carried > 0 && checkCollision(game.player, game.tractor)) {
        game.carried = 0; // descarga todas las alcachofas recolectadas
      }
      // Colisiones con obstÃ¡culos
      if (!game.player.isFrozen) {
        for (let obs of game.obstacles) {
          if (!obs.taken && checkCollision(game.player, obs)) {
            // Jugador tropieza con un obstÃ¡culo
            obs.taken = true;
            game.player.isFrozen = true;
            game.player.speed = 0;
            // Detener movimiento 3 segundos y cambiar sprite a "caÃ­do"
            setTimeout(() => {
              if (game.running) {
                game.player.isFrozen = false;
                // Restaurar velocidad segÃºn estado (cansado o normal)
                game.player.speed = game.player.isTired ? 1 : 2;
              }
            }, 3000);
            break;
          }
        }
      }
      // Verificar condiciÃ³n de victoria (todas las alcachofas recogidas y descargadas)
      if (game.collected >= game.config.TOTAL_ARTICHOKES && game.carried === 0) {
        game.running = false;
        const totalTime = ((performance.now() - game.startTime) / 1000).toFixed(1);
        game.ui.finalTime.textContent = `Tiempo total: ${totalTime} s`;
        game.ui.gameOver.style.display = 'block';
      }
      updateUI();
    }

    function updateUI() {
      const elapsed = Math.floor((performance.now() - game.startTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      game.ui.timer.textContent = `Tiempo: ${minutes}:${seconds}`;
      game.ui.artichokes.textContent = `Alcachofas: ${game.carried}/${game.config.MAX_CARRIED}`;
      game.ui.total.textContent = `Total recogidas: ${game.collected}`;
    }

    function render() {
      const ctx = game.ctx;
      // Dibujar fondo con textura segÃºn nivel (o color de tierra de respaldo)
      const bgAsset = game.assets['background' + game.level];
      if (bgAsset && bgAsset.img.complete && bgAsset.img.naturalHeight !== 0) {
        const pattern = ctx.createPattern(bgAsset.img, 'repeat');
        if (pattern) {
          ctx.fillStyle = pattern;
          ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);
        }
      } else {
        ctx.fillStyle = game.config.FIELD_COLOR;
        ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);
      }
      // Dibujar el tractor (o rectÃ¡ngulo verde de respaldo)
      if (game.assets.tractor.img.complete && game.assets.tractor.img.naturalHeight !== 0) {
        ctx.drawImage(game.assets.tractor.img, game.tractor.x, game.tractor.y, game.tractor.w, game.tractor.h);
      } else {
        ctx.fillStyle = '#006400';
        ctx.fillRect(game.tractor.x, game.tractor.y, game.tractor.w, game.tractor.h);
      }
      // Dibujar alcachofas no recogidas
      game.artichokes.forEach(a => {
        if (!a.taken) {
          if (game.assets.artichoke.img.complete && game.assets.artichoke.img.naturalHeight !== 0) {
            ctx.drawImage(game.assets.artichoke.img, a.x, a.y, a.w, a.h);
          } else {
            ctx.fillStyle = '#228B22';
            ctx.fillRect(a.x, a.y, a.w, a.h);
          }
        }
      });
      // Dibujar obstÃ¡culos restantes
      game.obstacles.forEach(obs => {
        if (!obs.taken) {
          const obsAsset = game.assets[obs.type];
          if (obsAsset.img.complete && obsAsset.img.naturalHeight !== 0) {
            ctx.drawImage(obsAsset.img, obs.x, obs.y, obs.w, obs.h);
          } else {
            ctx.fillStyle = '#777';
            ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
          }
        }
      });
      // Dibujar jugador (sprite normal, cansado o caÃ­do segÃºn estado)
      if (game.player.isFrozen && game.assets.playerFallen.img.complete && game.assets.playerFallen.img.naturalHeight !== 0) {
        ctx.drawImage(game.assets.playerFallen.img, game.player.x, game.player.y, game.player.w, game.player.h);
      } else if (game.player.isTired && game.assets.playerTired.img.complete && game.assets.playerTired.img.naturalHeight !== 0) {
        ctx.drawImage(game.assets.playerTired.img, game.player.x, game.player.y, game.player.w, game.player.h);
      } else if (game.assets.playerNormal.img.complete && game.assets.playerNormal.img.naturalHeight !== 0) {
        ctx.drawImage(game.assets.playerNormal.img, game.player.x, game.player.y, game.player.w, game.player.h);
      } else {
        ctx.fillStyle = '#00f';
        ctx.fillRect(game.player.x, game.player.y, game.player.w, game.player.h);
      }
    }

    // Funciones auxiliares
    const clamp = (value, min, max) => Math.max(min, Math.min(max, value));
    const checkCollision = (rect1, rect2) => (
      rect1.x < rect2.x + rect2.w &&
      rect1.x + rect1.w > rect2.x &&
      rect1.y < rect2.y + rect2.h &&
      rect1.y + rect1.h > rect2.y
    );

    function resizeCanvas() {
      game.canvas.width = window.innerWidth;
      game.canvas.height = window.innerHeight;
    }

    // Eventos de control de entrada
    window.addEventListener('keydown', e => {
      game.keys[e.key] = true;
      // Tecla Escape para pausar/reanudar
      if (e.key === 'Escape') {
        if (game.running && !game.paused) {
          pauseGame();
        } else if (game.paused) {
          resumeGame();
        }
      }
    });
    window.addEventListener('keyup', e => {
      game.keys[e.key] = false;
    });
    window.addEventListener('resize', resizeCanvas);

    // Cargar recursos al inicio
    initGameAssets();
  </script>
</body>
</html>
